import psycopg2
from psycopg2 import Error

class telemetry_database():
    def __init__(self):
        try:
            self.conn = psycopg2.connect(
                host="localhost",
                database="postgres",
                user="postgres",
                password="Team6"
            )

            self.cursor = self.conn.cursor()
            self.conn.autocommit = True

            print("Connected to the database successfully!")

        except (Exception, Error) as e:
            print(f"Error connecting to the database: {e}")

    def __del__(self):
        try:
            self.conn.close()
            self.cursor.close()

            print("Successfully closed connection to the database.")

        except (Exception, Error) as e:
            print(f"Error closing the database: {e}")

    def create_telemetry_data_table(self):

        self.cursor.execute("""

        SELECT EXISTS (
            SELECT FROM information_schema.tables 
            WHERE    table_name   = 'telemetry_data'
        );

        """)

        if self.cursor.fetchone()[0]:
            self.cursor.execute('DROP TABLE telemetry_data;')

        self.cursor.execute("""
                            
        CREATE TABLE telemetry_data (
        tel_index           INT GENERATED BY DEFAULT AS IDENTITY,
        time                FLOAT NOT NULL,        -- seconds
        distance            FLOAT,                  -- meters
        rel_distance        FLOAT,                  -- meters (normalized)
        track_coordinate_x  FLOAT,
        track_coordinate_y  FLOAT,
        track_coordinate_z  FLOAT,
        rpm                 FLOAT,
        gear                INT CHECK (gear BETWEEN 1 AND 8),
        throttle            FLOAT CHECK (throttle BETWEEN 0 AND 100),
        brake               BOOLEAN,
        drs                 drs_status,
        speed               FLOAT,                  -- km/h
        acc_x               FLOAT,                  -- m/s^2
        acc_y               FLOAT,                  -- m/s^2
        acc_z               FLOAT                   -- m/s^2
        );

        """)

        print(self.cursor.execute("""
        
        SELECT * from telemetry_data;

        """))

def main():
    db = telemetry_database()

    db.create_telemetry_data_table()

if __name__ == "__main__":
    main()